<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE project>
<project default="package" name="siebog" basedir="." xmlns:sonar="antlib:org.sonar.ant">
	<property environment="env" />
	<fail unless="env.JBOSS_HOME" message="Environment variable JBOSS_HOME not set." />
	<property name="env.HOSTNAME" value="${env.COMPUTERNAME}" />
	
	<property name="siebog.file" value="${env.JBOSS_HOME}/../siebog.war" />
	<property name="agents.file" value="${env.JBOSS_HOME}/../siebog-agents.war" />
	<property name="start.file" value="${env.JBOSS_HOME}/../siebog-start.jar" />
	<property name="start.modules" value="./wildfly-9.x/modules/system/layers/base" />
	
	<property name="jboss.cli" value="${env.JBOSS_HOME}/bin/jboss-cli.sh" />
	<property name="controller" value="remoting://localhost" />
	
	<property name="dist.dir" value="../www/web/dist" />
	<property name="dist.temp.dir" value="${dist.dir}/siebog" />
	<property name="javadoc.dir" value="${dist.dir}/javadoc" />
	
	<property name="wildfly.modules" value="${dist.temp.dir}/wildfly-9.x/modules/system/layers/base" />

	<!--property name="sonar.jdbc.url" value="jdbc:mysql://localhost:3306/sonar?useUnicode=true&amp;characterEncoding=utf8" />
	<property name="sonar.jdbc.username" value="sonar" />
	<property name="sonar.jdbc.password" value="sonar" /-->

	<property name="sonar.projectKey" value="siebog" />
	<property name="sonar.projectName" value="siebog" />
	<property name="sonar.projectVersion" value="1.0" />
	<property name="sonar.language" value="java" />
	<property name="sonar.sources" value="src" />
	<property name="sonar.binaries" value="war/WEB-INF/classes" />
	
	<target name="package">
		<delete file="${siebog.file}" />
		<delete file="${agents.file}" />
		<delete file="${start.file}" />
		
		<war destfile="${siebog.file}" webxml="war/WEB-INF/web.xml" manifest="war/META-INF/MANIFEST.MF">
			<fileset dir="war" includes="WEB-INF/classes/**" />
			<fileset dir="war" includes="WEB-INF/jboss-web.xml" />
			<fileset dir="war" includes="*.html" />
			<fileset dir="war" includes="css/**,font/**,img/**,js/**" />
		</war>
		
		<war destfile="${agents.file}" webxml="../siebog-agents/war/WEB-INF/web.xml" manifest="../siebog-agents/war/META-INF/MANIFEST.MF">
			<fileset dir="../siebog-agents/war" includes="WEB-INF/classes/**" />
			<fileset dir="../siebog-agents/war" includes="WEB-INF/jboss-web.xml" />
		</war>
		
        <jar destfile="${start.file}">
            <manifest>
                <attribute name="Main-Class" value="siebog.server.NodeStarter"/>
                <attribute name="Class-Path" value=". ./wildfly-9.x/bin/client/jboss-cli-client.jar ${start.modules}/org/jboss/as/process-controller/main/wildfly-process-controller-1.0.0.Alpha3.jar ${start.modules}/org/jboss/as/controller-client/main/wildfly-controller-client-1.0.0.Alpha3.jar ${start.modules}/org/jboss/logmanager/main/jboss-logmanager-1.5.2.Final.jar"/>
            </manifest>
            <fileset dir="../siebog-start/bin"/>
        </jar>
	</target>

	<target name="sonar">
		<taskdef uri="antlib:org.sonar.ant" resource="org/sonar/ant/antlib.xml">
			<classpath path="lib/sonar-ant-task-2.2.jar" />
		</taskdef>

		<sonar:sonar />
	</target>

	<target name="undeploy-siebog">
		<exec executable="/bin/bash">
			<arg value="${jboss.cli}" />
			<arg value="--connect" />
			<arg value="--controller=${controller}" />
			<arg value='undeploy siebog.war --server-groups=xjaf2x-group' />
		</exec>
	</target>

	<target name="deploy-siebog" depends="package, undeploy-siebog">
		<exec executable="/bin/bash">
			<arg value="${jboss.cli}" />
			<arg value="--connect" />
			<arg value="--controller=${controller}" />
			<arg value='deploy ${siebog.file} --name=siebog.war --server-groups=xjaf2x-group' />
		</exec>
	</target>
	
	<target name="undeploy-agents">
		<exec executable="/bin/bash">
			<arg value="${jboss.cli}" />
			<arg value="--connect" />
			<arg value="--controller=${controller}" />
			<arg value='undeploy siebog-agents.war --server-groups=xjaf2x-group' />
		</exec>
	</target>
	
	<target name="deploy-agents" depends="package, undeploy-agents">
		<exec executable="/bin/bash">
			<arg value="${jboss.cli}" />
			<arg value="--connect" />
			<arg value="--controller=${controller}" />
			<arg value='deploy ${agents.file} --name=siebog-agents.war --server-groups=xjaf2x-group' />
		</exec>
	</target>
	
	<target name="deploy-all" depends="deploy-siebog, deploy-agents" />

	<target name="dist" depends="package">
		<mkdir dir="${dist.temp.dir}" />
		
		<!-- copy server -->
		<mkdir dir="${dist.temp.dir}/wildfly-9.x" />
		<copy todir="${dist.temp.dir}/wildfly-9.x">
			<fileset dir="/home/dejan/dev/siebog/base/wildfly-9.x" includes="**" />
		</copy>
		<!-- copy modules -->
		<delete dir="${wildfly.modules}/siebog-core" />
		<mkdir dir="${wildfly.modules}/siebog-core/main" />
		<copy todir="${wildfly.modules}/siebog-core/main">
			<fileset dir="${basedir}/lib/module" includes="*.jar,*.xml" />
		</copy>
		
		<!-- copy binaries -->
		<copy todir="${dist.temp.dir}">
			<fileset dir="${env.JBOSS_HOME}/.." includes="siebog.war,siebog-agents.war,siebog-start.jar" />
			<fileset dir="${basedir}/.." includes="LICENSE.txt,NOTICE.txt" />
		</copy>
		
		<!-- pack -->
		<zip destfile="${dist.dir}/siebog.zip" basedir="${dist.dir}" includes="siebog/**" />
		
		<!-- cleanup -->
		<delete dir="${dist.temp.dir}" />
	</target>
</project>
