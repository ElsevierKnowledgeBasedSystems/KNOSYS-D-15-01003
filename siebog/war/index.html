<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Dashboard - Siebog Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/bootstrap-responsive.min.css" rel="stylesheet">
<link href="http://fonts.googleapis.com/css?family=Open+Sans:400italic,600italic,400,600" rel="stylesheet">
<link href="css/font-awesome.css" rel="stylesheet">
<link href="css/style.css" rel="stylesheet">
<link href="css/pages/dashboard.css" rel="stylesheet">
</head>
<body>

	<div class="navbar navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container">
				<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> <span class="icon-bar"></span><span
					class="icon-bar"></span><span class="icon-bar"></span>
				</a><a class="brand" href="index.html">Siebog Admin</a>
			</div>
		</div>
	</div>

	<div class="subnavbar">
		<div class="subnavbar-inner">
			<div class="container">
				<ul class="mainnav">
					<li class="active"><a href="index.html"><i class="icon-dashboard"></i><span>Dashboard</span></a></li>
					<li><a href="messages.html"><i class="icon-rss"></i><span>Messages</span></a></li>
					<li><a href="deployagents.html"><i class="icon-upload-alt"></i><span>Deploy Agents</span></a></li>
					<li><a href="cluster.html"><i class="icon-sitemap"></i><span>Cluster</span></a></li>
				</ul>
			</div>
		</div>
	</div>

	<div class="main">
		<div class="main-inner">
			<div class="container">
				<div class="row">

					<div class="span6">
						<div class="widget widget-table action-table">
							<div class="widget-header">
								<i class="icon-play"></i>
								<h3>Run new agent</h3>
								<button onclick="javascript:getDeployed();" class="btn btn-success"
									style="float: right; margin-right: 10px; margin-top: 6px">Reload</button>
							</div>
							<div class="widget-content">
								<div style="height: 400px; overflow-y: scroll;">
									<table class="table table-striped table-bordered">
										<tbody id="families-table">

										</tbody>
									</table>
								</div>
								<div class="control-group" style="background-color: #F1F1F1; padding-top: 8px;">
									<span style="float: left; margin-left: 10px; margin-top: 10px; padding-top: 2px;">Agent runtime name: </span> <input
										style="float: left; margin-left: 10px; margin-top: 10px; width: 350px;" class="span2 m-wrap"
										id="agentnameinput" type="text">
									<button onclick="javascript:startAgent();" style="float: left; margin-top: 10px; margin-left: -2px" class="btn"
										type="button">RUN</button>
								</div>
							</div>
						</div>
					</div>

					<div class="span6">
						<div class="widget widget-table action-table">
							<div class="widget-header">
								<i class="icon-rss"></i>
								<h3>Running agents</h3>
								<button onclick="javascript:getRunningAgents();" class="btn btn-success"
									style="float: right; margin-right: 10px; margin-top: 6px">Reload</button>
							</div>
							<div class="widget-content">
								<div style="height: 400px; overflow-y: scroll;">
									<table class="table table-striped table-bordered">
										<tbody id="running-table">

										</tbody>
									</table>
								</div>
								<div class="control-group" style="background-color: #F1F1F1; padding-top: 8px;">
									<span style="float: left; margin-left: 10px; margin-top: 10px; padding-top: 2px;">Send Quick Message: </span> <select
										style="float: left; margin-left: 10px; margin-top: 10px; width: 170px;" id="performatives-list"
										name="selectedperformative">

									</select> <input style="float: left; margin-left: 10px; margin-top: 10px; width: 160px;" class="span2 m-wrap"
										id="contentmessageinput" type="text">
									<button onclick="javascript:sendQuickMessage();" style="float: left; margin-top: 10px; margin-left: -2px"
										class="btn" type="button">SEND</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- log console -->
	<div id="menuDiv">
		<div id="menuInfo">
			<div id="menuInfoWrapper" class="menuWrapper hidden">
				<div id='menuInfoFormDiv' class="hidden">
					<div id="menuInfoForm1" class="menuForm">
						xjaf<br>
						<table>
							<tr>
								<td>13:16:27,436</td>
								<td>INFO</td>
								<td>[org.hibernate.validator.internal.util.Version] (http-localhost/127.0.0.1:8080-5) HV000001: Hibernate
									Validator 4.3.1.Final</td>
							</tr>
							<tr>
								<td>13:16:27,849</td>
								<td>INFO</td>
								<td>[org.jboss.ejb.client] (http-localhost/127.0.0.1:8080-4) JBoss EJB Client version 1.0.16.Final</td>
							</tr>
							<tr>
								<td>13:16:28,053</td>
								<td>INFO</td>
								<td>[xjaf.server.agents.ping.PingAgent] (pool-18-thread-1) Ping @ [zoran]</td>
							</tr>
							<tr>
								<td>13:17:52,088</td>
								<td>INFO</td>
								<td>[xjaf.server.messagemanager.MessageManager] (pool-18-thread-1) Agent not running:
									[xjaf_server_agents_ping_PongAgent/fdf]</td>
							</tr>
							<tr>
								<td>13:16:27,436</td>
								<td>INFO</td>
								<td>[org.hibernate.validator.internal.util.Version] (http-localhost/127.0.0.1:8080-5) HV000001: Hibernate
									Validator 4.3.1.Final</td>
							</tr>
							<tr>
								<td>13:16:27,849</td>
								<td>INFO</td>
								<td>[org.jboss.ejb.client] (http-localhost/127.0.0.1:8080-4) JBoss EJB Client version 1.0.16.Final</td>
							</tr>
							<tr>
								<td>13:16:28,053</td>
								<td>INFO</td>
								<td>[xjaf.server.agents.ping.PingAgent] (pool-18-thread-1) Ping @ [zoran]</td>
							</tr>
							<tr>
								<td>13:17:52,088</td>
								<td>INFO</td>
								<td>[xjaf.server.messagemanager.MessageManager] (pool-18-thread-1) Agent not running:
									[xjaf_server_agents_ping_PongAgent/fdf]</td>
							</tr>
						</table>
					</div>

				</div>
				<div id="menuInfoTabs" class="menuTabs">
					<div id="menuInfoTabShow" class="clickable tab showHide inActive" onclick="tab(this.id);">Show Logs</div>
					<div id="menuInfoTabHide" class="clickable tab showHide inActive hidden" onclick="tab(this.id);">Hide Logs</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Placed at the end of the document so the pages load faster -->
	<script src="js/jquery-1.7.2.min.js"></script>
	<script src="js/excanvas.min.js"></script>
	<script src="js/chart.min.js" type="text/javascript"></script>
	<script src="js/bootstrap.js"></script>
	<script src="js/base.js"></script>
	<script src="js/treemodel/TreeModel.js"></script>
	<script src="js/toggle.js"></script>

	<script src="js/siebog/xjaf.js"></script>

	<script type="text/javascript">

	function trimAgentPath(agentPath) {
		var len1 = agentPath.length - 1;
    	if (agentPath.lastIndexOf("_") == len1)
    		agentPath = agentPath.substring(0, len1);
    	return agentPath;
	}

	function getDeployed() {
		$("#families-table").empty();
		xjaf.getDeployed(function(list) {
			tree = new TreeModel();
			root = tree.parse({ id: 'root', level: 0, isAgent: false });
			
			$.each(list, function(i, aid) {
				var nodeModule = root.first(function (node) { 
					return ((node.model.id === aid.module) && (node.model.level == 1)); 
				});
				if (nodeModule == null) {
					nodeModule = tree.parse({ id: aid.module, level: 1, isAgent: false });
					root.addChild(nodeModule);
				}

				var ejbName = tree.parse({ id: aid.ejbName, level: 2, isAgent: true });
				nodeModule.addChild(ejbName);
			});
				
			var agentPath = "";
			var lastLevel = 0;
			root.walk(function (node) {
			    if (node.model.level > 0) {
				    if (!node.model.isAgent) {
				    	if (node.model.level == 1) {
				    		agentPath = node.model.id + "/";
				    		lastLevel == 1;
				    		$("#families-table").append('<tr><td colspan="2" style="padding-left:10px"><img src="img/module.png" style="margin-right:5px;" />' + node.model.id + '</td></tr>');
				    	} else {
				    		if (node.model.level < lastLevel) {
				    			for (var i = 0; i < (lastLevel - node.model.level); i++)
				    				agentPath = agentPath.substring(0, agentPath.lastIndexOf("_"));
			    			}
				    		agentPath = agentPath + ((node.model.level == 2) ? "" : "_") + node.model.id;
				    		lastLevel = node.model.level;
				    		$("#families-table").append('<tr><td colspan="2" style="padding-left:' + ((node.model.level - 1) * 20) + 'px"><img src="img/package.png" style="margin-right:5px;" />' + node.model.id + '</td></tr>');
			    		}
				    }
				    else {
				    	$("#families-table").append('<tr><td colspan="2" style="padding-left:' + ((node.model.level - 1) * 20) + 'px"><input type="radio" name="selectedfamily" value="' + (trimAgentPath(agentPath) + node.model.id) + '" style="margin-right:5px;"/>' + node.model.id + '</td></tr>');
				    	lastLevel = node.model.level;
				   	}
			    }
			});
		});
	}
	
	function getRunningAgents() {
		$("#running-table").empty();
		xjaf.getRunning(function(list) {
			tree = new TreeModel();
			root = tree.parse({ id: 'root', level: 0, isAgent: false });
			
			$.each(list, function(i, aid) {
				var nodeModule = root.first(function (node) { 
					return ((node.model.id === aid.module) && (node.model.level == 1)); 
				});
				if (nodeModule == null) {
					nodeModule = tree.parse({ id: aid.module, level: 1, isAgent: false });
					root.addChild(nodeModule);
				}

				var ejbName = tree.parse({ id: aid.ejbName, level: 2, isAgent: true });
				nodeModule.addChild(ejbName);
			});
				
				
			var agentPath = "";
			var deletePath = "";
			var lastLevel = 0;
			root.walk(function (node) {
			    if (node.model.level > 0) {
				    if (!node.model.isAgent) {
				    	if (node.model.level == 1) {
				    		agentPath = node.model.id + "@";
				    		deletePath = node.model.id + "/";
				    		lastLevel == 1;
				    		$("#running-table").append('<tr><td colspan="2" style="padding-left:10px"><img src="img/module.png" style="margin-right:5px;" />' + node.model.id + '</td></tr>');
				    	} else {
				    		if (node.model.level < lastLevel) {
				    			for (var i = 0; i < (lastLevel - node.model.level); i++) {
				    				agentPath = agentPath.substring(0, agentPath.lastIndexOf("_"));
				    				deletePath = deletePath.substring(0, deletePath.lastIndexOf("_"));
				    			}
			    			}
				    		agentPath = agentPath + ((node.model.level == 2) ? "" : "_") + node.model.id;
				    		deletePath = deletePath + ((node.model.level == 2) ? "" : "_") + node.model.id;
				    		lastLevel = node.model.level;
				    		$("#running-table").append('<tr><td colspan="2" style="padding-left:' + ((node.model.level - 1) * 20) + 'px"><img src="img/package.png" style="margin-right:5px;" />' + node.model.id + '</td></tr>');
			    		}
				    } else {
				    	$("#running-table").append('<tr><td colspan="2" style="padding-left:' + ((node.model.level - 1) * 20) + 'px"><input type="checkbox" name="selectedagent" value="' + (trimAgentPath(agentPath) + node.model.id.split('/')[0] + "@" + node.model.id.split('/')[1]) + '" style="margin-right:5px;"/>' + node.model.id.split('/')[0] + ":   <b>" + node.model.id.split('/')[1] + "</b>" + '<a href="javascript:stopAgent(\'' + (deletePath + "_" + node.model.id.split('/')[0] + "/" + node.model.id.split('/')[1])  + '\');" class="btn btn-danger btn-small" style="float:right"><i class="btn-icon-only icon-remove"> </i></a></td></tr>');
				    	lastLevel = node.model.level;
				   	}
			    }
			});
		});
	}
	
	function getAllPerformatives() {
		$("#performatives-list").empty();
		xjaf.getPerformatives(function(list) {
			$.each(list, function(i, per) {
				$("#performatives-list").append('<option value="' + per + '">' + per + '</option>');
			});	
		});
	}
	
	function stopAgent(agent)
	{
		jQuery.ajax({
			type: "GET",
			url: "rest/remove/" + agent,
			dataType: "json",
			success: function (data) 
			{
				getRunningAgents();
			}
		 });
	}
	
	function startAgent()
	{	
		var moduleAndEjbName = $('input[name=selectedfamily]:checked').val();
		var runtimeName = $('#agentnameinput').val();
		if (moduleAndEjbName != null && runtimeName != "") {
			xjaf.start(moduleAndEjbName, runtimeName, function(data) {
				$('#agentnameinput').val("");
				getRunningAgents();
			});
		}
		else
			alert("Please select an agent class and specify the runtime name.");
	}
	
	function sendQuickMessage()
	{		
		var selectedagents = "";
		
		$('input[name=selectedagent]:checked').each(function () {
			selectedagents = selectedagents + "," + $(this).val();
		});
		
		selectedagents = selectedagents.substring(1, selectedagents.length);
		
		if ((selectedagents != "") && ($('#contentmessageinput').val() != ""))
		{
			jQuery.ajax({
				type: "GET",
				url: "rest/msm/postquickmsg/" + selectedagents + "/" + $('select[name=selectedperformative]').val() + "/" + $('#contentmessageinput').val(),
				dataType: "json",
				success: function (data)
				{
					$('#contentmessageinput').val("");
					if (data.success == true)
						alert("Message was sent successfully.");
					else
						alert("Error");
				}
			});
		}
		else
		{
			alert("Please select Agent and enter Message content.");
		}
	}
	
	getDeployed();
	//getRunningAgents();
	getAllPerformatives();
	 
	 
</script>

</body>
</html>
